<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Albero genealogico interattivo</title>
  <style>
    :root {
      --bg: #f7f8fa;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --accent: #22c55e;
      --accent-ink: #065f46;
      --line: #94a3b8;
    }

    html, body {
      margin: 0; height: 100%; background: var(--bg); color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 14px 18px; background: var(--card); box-shadow: 0 2px 8px rgba(0,0,0,.06);
      position: sticky; top: 0; z-index: 5;
    }

    header h1 { font-size: 18px; margin: 0; font-weight: 700; }
    header .hint { color: var(--muted); font-size: 12px; }

    .toolbar {
      display: flex; flex-wrap: wrap; gap: 10px; align-items: end;
    }

    .field { display: grid; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); }
    .field input, .field select {
      height: 36px; border: 1px solid #e5e7eb; border-radius: 10px; padding: 0 10px; background: #fff; min-width: 160px;
    }

    button.primary {
      height: 38px; padding: 0 14px; border: 0; border-radius: 12px; background: var(--accent); color: white; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 10px rgba(34,197,94,.25);
    }
    button.primary:active { transform: translateY(1px); }

    main { height: calc(100% - 72px); display: grid; grid-template-columns: 280px 1fr; }

    aside {
      border-right: 1px solid #eef2f7; background: var(--card);
      padding: 16px; overflow: auto;
    }

    aside h2 { font-size: 14px; margin: 0 0 10px; }
    .stack { display: grid; gap: 10px; }
    .card {
      background: var(--card); border: 1px solid #eef2f7; border-radius: 14px; padding: 12px; display: grid; gap: 10px;
    }

    .mini-list { display: grid; gap: 8px; }
    .mini-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); }

    /* Canvas */
    .viewport {
      position: relative; overflow: hidden; background: radial-gradient(1200px 800px at 20% -10%, #ffffff, #f3f4f6);
    }

    #canvas {
      position: absolute; inset: 0; transform-origin: 0 0; user-select: none;
    }

    svg.links { position: absolute; inset: 0; overflow: visible; }

    .link { stroke: var(--line); stroke-width: 2; fill: none; }

    .node {
      position: absolute; width: 140px; text-align: center; cursor: default;
    }

    .avatar {
      width: 110px; height: 110px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto; border: 3px solid var(--accent);
      background: #e5e7eb;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }

    .label { font-weight: 700; margin-top: 8px; font-size: 14px; }
    .sub { color: var(--muted); font-size: 12px; }

    .node.selected .avatar { outline: 3px solid #0ea5e9; border-color: #0ea5e9; }

    .legend { font-size: 12px; color: var(--muted); }

    .pan-hint { position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,.9); padding: 6px 10px; border-radius: 10px; border: 1px solid #e5e7eb; font-size: 12px; }

    .footer-bar { position: absolute; right: 12px; bottom: 12px; display: flex; gap: 8px; }
    .iconbtn {
      width: 38px; height: 38px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; cursor: pointer; font-weight: 900;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Albero genealogico interattivo</h1>
      <div class="hint">Foto tonde + nomi, collegamenti genitori â†’ figli. Trascina per muoverti, rotellina per zoom.</div>
    </div>
    <div class="toolbar">
      <div class="field">
        <label for="name">Nome completo</label>
        <input id="name" placeholder="Es. Mario Rossi" />
      </div>
      <div class="field">
        <label for="photo">URL foto (https://...)</label>
        <input id="photo" placeholder="https://..." />
      </div>
      <div class="field">
        <label for="parentA">Genitore A (opz.)</label>
        <select id="parentA"></select>
      </div>
      <div class="field">
        <label for="parentB">Genitore B (opz.)</label>
        <select id="parentB"></select>
      </div>
      <button class="primary" id="add">Aggiungi persona</button>
    </div>
  </header>

  <main>
    <aside>
      <div class="stack">
        <div class="card">
          <h2>Istruzioni veloci</h2>
          <ul class="mini-list">
            <li class="mini-item"><span class="dot"></span>Compila nome e (se vuoi) URL foto.</li>
            <li class="mini-item"><span class="dot"></span>Seleziona fino a due genitori per posizionare i figli.</li>
            <li class="mini-item"><span class="dot"></span>Clic su un nodo per selezionarlo.</li>
            <li class="mini-item"><span class="dot"></span>Trascina lo sfondo per spostare la vista, rotellina per zoom.</li>
          </ul>
        </div>
        <div class="card">
          <h2>Esporta / Importa</h2>
          <div class="mini-list">
            <button class="primary" id="export">Esporta JSON</button>
            <input type="file" id="import" accept="application/json" />
            <div class="legend">Puoi salvare il tuo albero come file JSON e ricaricarlo.</div>
          </div>
        </div>
      </div>
    </aside>

    <div class="viewport" id="viewport">
      <div id="canvas">
        <svg class="links" id="links" xmlns="http://www.w3.org/2000/svg"></svg>
        <!-- Nodes render here -->
      </div>
      <div class="pan-hint">ðŸ’¡ Trascina per muovere â€¢ Rotellina per zoom â€¢ Doppio click per centrare</div>
      <div class="footer-bar">
        <button class="iconbtn" id="zoomOut">âˆ’</button>
        <button class="iconbtn" id="reset">âŸ³</button>
        <button class="iconbtn" id="zoomIn">+</button>
      </div>
    </div>
  </main>

  <script>
    // --- Dati ---
    const state = {
      people: {},   // id -> { id, name, photo, parents: [id,id?] }
      order: [],    // rendering order (ids)
      nextId: 1,
      transform: { x: 300, y: 120, k: 1 },
      selected: null,
    };

    // Helpers
    const byId = id => state.people[id];

    function addPerson(name, photo, parentA = null, parentB = null) {
      const id = String(state.nextId++);
      state.people[id] = { id, name: name.trim(), photo: (photo || '').trim(), parents: [] };
      if (parentA) state.people[id].parents.push(parentA);
      if (parentB && parentB !== parentA) state.people[id].parents.push(parentB);
      state.order.push(id);
      layout();
      render();
      refreshSelectors();
      return id;
    }

    function refreshSelectors() {
      const options = ["", ...state.order];
      for (const sel of [parentA, parentB]) {
        const cur = sel.value;
        sel.innerHTML = "";
        const none = document.createElement('option'); none.value = ""; none.textContent = "(nessuno)"; sel.appendChild(none);
        options.slice(1).forEach(id => {
          const o = document.createElement('option');
          o.value = id; o.textContent = byId(id).name || `ID ${id}`;
          sel.appendChild(o);
        });
        sel.value = options.includes(cur) ? cur : "";
      }
    }

    // --- Layout semplice per livelli ---
    // 1) Compute depth via BFS from roots (no parents).
    function computeDepths() {
      const indeg = {}; const depth = {}; const children = {};
      for (const id of state.order) {
        indeg[id] = (byId(id).parents || []).length;
        children[id] = [];
      }
      for (const id of state.order) {
        for (const p of byId(id).parents) {
          if (children[p]) children[p].push(id);
        }
      }
      const q = [];
      for (const id of state.order) if (indeg[id] === 0) { depth[id] = 0; q.push(id); }
      while (q.length) {
        const u = q.shift();
        for (const v of children[u]) {
          depth[v] = Math.max(depth[v] ?? 0, (depth[u] ?? 0) + 1);
          indeg[v]--; if (indeg[v] === 0) q.push(v);
        }
      }
      // nodes still without depth (cycles or only parents missing): set to 0
      for (const id of state.order) if (depth[id] == null) depth[id] = 0;
      return { depth, children };
    }

    // 2) Place nodes on grid by depth (y) and order (x). Then center children under average x of their parents.
    const positions = {}; // id -> {x, y}
    function layout() {
      const { depth, children } = computeDepths();
      const byLevel = {};
      for (const id of state.order) {
        const d = depth[id];
        if (!byLevel[d]) byLevel[d] = [];
        byLevel[d].push(id);
      }
      const levelGap = 200; const nodeGap = 200;
      for (const [lvl, arr] of Object.entries(byLevel)) {
        arr.forEach((id, i) => {
          positions[id] = { x: i * nodeGap, y: Number(lvl) * levelGap };
        });
      }
      // Adjust x by averaging parents' x
      for (const id of state.order) {
        const ps = byId(id).parents;
        if (ps && ps.length) {
          const xs = ps.map(p => positions[p]?.x).filter(x => x != null);
          if (xs.length) {
            const avg = xs.reduce((a,b)=>a+b,0)/xs.length;
            positions[id].x = avg;
          }
        }
      }
      // Normalize to avoid negative positions and center layout
      const xs = Object.values(positions).map(p=>p.x);
      const minX = Math.min(...xs, 0);
      if (minX < 0) {
        for (const id of state.order) positions[id].x -= minX;
      }
    }

    // --- Rendering ---
    const canvas = document.getElementById('canvas');
    const linksSvg = document.getElementById('links');

    function render() {
      // clear nodes
      canvas.querySelectorAll('.node').forEach(n => n.remove());
      // draw nodes
      for (const id of state.order) {
        const p = byId(id); const pos = positions[id] || {x:0,y:0};
        const node = document.createElement('div');
        node.className = 'node'; node.style.left = (pos.x + 30) + 'px'; node.style.top = (pos.y + 30) + 'px';
        node.dataset.id = id;
        node.innerHTML = `
          <img class="avatar" src="${p.photo || 'https://via.placeholder.com/200?text=Foto'}" alt="${p.name}">
          <div class="label">${p.name || 'Senza nome'}</div>
          <div class="sub">ID ${id}${(p.parents?.length?` â€¢ gen: ${p.parents.join(', ')}`:'')}</div>
        `;
        node.addEventListener('click', () => selectNode(id));
        canvas.appendChild(node);
      }
      // links
      drawLinks();
      applyTransform();
    }

    function pathCubic(x1,y1,x2,y2) {
      const dx = (x2 - x1) * 0.5;
      return `M ${x1} ${y1} C ${x1+dx} ${y1}, ${x2-dx} ${y2}, ${x2} ${y2}`;
    }

    function drawLinks() {
      linksSvg.innerHTML = '';
      for (const id of state.order) {
        const child = positions[id];
        const ps = byId(id).parents || [];
        for (const pId of ps) {
          const par = positions[pId];
          if (!par) continue;
          const x1 = par.x + 100; const y1 = par.y + 110; // bottom of parent avatar
          const x2 = child.x + 100; const y2 = child.y + 20;   // top of child avatar
          const path = document.createElementNS('http://www.w3.org/2000/svg','path');
          path.setAttribute('class','link');
          path.setAttribute('d', pathCubic(x1,y1,x2,y2));
          linksSvg.appendChild(path);
        }
      }
    }

    function selectNode(id) {
      state.selected = id;
      canvas.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
      const el = canvas.querySelector(`.node[data-id="${CSS.escape(id)}"]`);
      if (el) el.classList.add('selected');
    }

    // --- Pan & Zoom ---
    const viewport = document.getElementById('viewport');
    let dragging = false; let last = {x:0,y:0};

    viewport.addEventListener('mousedown', (e) => {
      if (e.target.closest('.node') || e.target.closest('header') || e.target.closest('aside')) return;
      dragging = true; last = {x:e.clientX, y:e.clientY};
    });
    window.addEventListener('mouseup', ()=> dragging=false);
    window.addEventListener('mousemove', (e)=>{
      if (!dragging) return;
      const dx = e.clientX - last.x; const dy = e.clientY - last.y;
      state.transform.x += dx; state.transform.y += dy; last = {x:e.clientX, y:e.clientY};
      applyTransform();
    });

    viewport.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const delta = Math.sign(e.deltaY) * 0.1;
      const k0 = state.transform.k;
      let k = Math.min(2.2, Math.max(0.4, k0 * (1 - delta)));
      // zoom to cursor
      const rect = viewport.getBoundingClientRect();
      const cx = e.clientX - rect.left; const cy = e.clientY - rect.top;
      const x0 = (cx - state.transform.x) / k0; const y0 = (cy - state.transform.y) / k0;
      state.transform.k = k;
      state.transform.x = cx - x0 * k;
      state.transform.y = cy - y0 * k;
      applyTransform();
    }, { passive: false });

    viewport.addEventListener('dblclick', ()=>{
      state.transform = { x: 300, y: 120, k: 1 };
      applyTransform();
    });

    function applyTransform() {
      const t = state.transform;
      const m = `translate(${t.x}px, ${t.y}px) scale(${t.k})`;
      canvas.style.transform = m;
    }

    // --- Export / Import ---
    document.getElementById('export').addEventListener('click', ()=>{
      const data = { people: state.people, order: state.order, nextId: state.nextId };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'albero.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });

    document.getElementById('import').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (!data.people || !data.order) throw new Error('Formato non valido');
        state.people = data.people; state.order = data.order; state.nextId = data.nextId || (Math.max(0, ...data.order.map(Number))+1);
        layout(); render(); refreshSelectors();
      } catch (err) {
        alert('Errore importazione: ' + err.message);
      }
    });

    // --- UI add ---
    const nameInput = document.getElementById('name');
    const photoInput = document.getElementById('photo');
    const parentA = document.getElementById('parentA');
    const parentB = document.getElementById('parentB');

    document.getElementById('add').addEventListener('click', ()=>{
      const name = nameInput.value.trim();
      if (!name) { alert('Inserisci almeno il nome completo'); return; }
      const pa = parentA.value || null;
      const pb = parentB.value || null;
      const id = addPerson(name, photoInput.value.trim(), pa, pb);
      nameInput.value = ''; photoInput.value = '';
      parentA.value = ''; parentB.value = '';
      selectNode(id);
    });

    // --- Zoom buttons ---
    document.getElementById('zoomIn').addEventListener('click', ()=>{
      const e = new WheelEvent('wheel', { deltaY: -120, bubbles: true, cancelable: true });
      viewport.dispatchEvent(e);
    });
    document.getElementById('zoomOut').addEventListener('click', ()=>{
      const e = new WheelEvent('wheel', { deltaY: 120, bubbles: true, cancelable: true });
      viewport.dispatchEvent(e);
    });
    document.getElementById('reset').addEventListener('click', ()=>{
      state.transform = { x: 300, y: 120, k: 1 }; applyTransform();
    });

    // --- Demo iniziale ---
    const idNonno = addPerson('Giuseppe (nonno)', 'https://images.unsplash.com/photo-1602471060926-5f1e1c3f1b8a?q=80&w=300');
    const idNonna = addPerson('Anna (nonna)', 'https://images.unsplash.com/photo-1551836022-4c4c79ecde51?q=80&w=300');
    const idPadre = addPerson('Marco (padre)', 'https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?q=80&w=300', idNonno, idNonna);
    const idMadre = addPerson('Lucia (madre)', 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=300');
    addPerson('Renato (tu)', 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=300', idPadre, idMadre);
    refreshSelectors();
  </script>
</body>
</html>
